# RDS IAM Authentication Implementation - Build Log

**Date:** October 20, 2025
**Change Set:** `import-existing-rds-sg` (01K81E9XBWS2FV4W7VVAG7AYN8)
**Status:** Ready for Apply

---

## Overview

This build log documents the implementation of RDS Aurora PostgreSQL with IAM authentication via RDS Proxy for the Tony's Chips application in the sandbox environment. The implementation includes both infrastructure changes (System Initiative) and application code changes.

---

## Infrastructure Changes (System Initiative)

### Components Created

#### 1. Sandbox API Security Group
**Component:** `sandbox-tonys-chips-api-sg` (01K81E0AGTC1MXDPEQ2SG2CKPM)
**Schema:** AWS::EC2::SecurityGroup
**Purpose:** Security group for the API ECS tasks in the sandbox VPC

**Configuration:**
```json
{
  "GroupName": "sandbox-tonys-chips-api-sg",
  "GroupDescription": "Security group for Tonys Chips API server in sandbox - allows HTTP traffic",
  "VpcId": "vpc-0bc7327e9bc2204c2",
  "SecurityGroupIngress": [
    {
      "IpProtocol": "tcp",
      "FromPort": 8080,
      "ToPort": 8080,
      "CidrIp": "0.0.0.0/0",
      "Description": "Web app access"
    }
  ],
  "Tags": [
    {"Key": "Name", "Value": "sandbox-tonys-chips-api-sg"},
    {"Key": "Environment", "Value": "Sandbox"},
    {"Key": "Owner", "Value": "devops@tonys-chips.com"},
    {"Key": "CostCenter", "Value": "DevelopmentSandbox"},
    {"Key": "Application", "Value": "tonys-chips-api"}
  ]
}
```

#### 2. RDS Security Group (Imported & Updated)
**Component:** `sandbox-tonys-chips-rds-sg` (01K81EABMN04CFEGEAE3NZXMCS)
**Resource ID:** `sg-03f67b88dbd4ca2bd`
**Schema:** AWS::EC2::SecurityGroup
**Purpose:** Security group for RDS Aurora cluster and RDS Proxy

**Configuration:**
```json
{
  "GroupName": "tonys-chips-rds-sg",
  "GroupDescription": "Security group for Tonys Chips RDS Aurora cluster",
  "VpcId": "vpc-0bc7327e9bc2204c2",
  "SecurityGroupIngress": [
    {
      "IpProtocol": "tcp",
      "FromPort": 5432,
      "ToPort": 5432,
      "Description": "PostgreSQL access from API",
      "SourceSecurityGroupId": "subscription to sandbox-tonys-chips-api-sg"
    }
  ]
}
```

**Key Changes:**
- Imported existing security group `sg-03f67b88dbd4ca2bd` from AWS
- Renamed component from `sg-03f67b88dbd4ca2bd` to `sandbox-tonys-chips-rds-sg`
- Added ingress rule to allow PostgreSQL traffic from API security group only
- Fixed description to remove apostrophe (was "Tony's Chips", now "Tonys Chips")

#### 3. DB Subnet Group
**Component:** `sandbox-tonys-chips-db-subnet-group` (01K8169JVZHQK70RQJYFBA3XE6)
**Schema:** AWS::RDS::DBSubnetGroup
**Purpose:** Defines subnets for RDS cluster deployment

**Configuration:**
- Uses private subnets in us-east-1a and us-east-1b
- Subnets:
  - `tonys-chips-sandbox-vpc-subnet-priv-1`
  - `tonys-chips-sandbox-vpc-subnet-priv-2`

#### 4. RDS Aurora PostgreSQL Cluster
**Component:** `sandbox-tonys-chips-aurora-postgres` (01K816B0YPKFSYE7196TVJRYXC)
**Schema:** AWS::RDS::DBCluster
**Purpose:** PostgreSQL database cluster

**Configuration:**
```json
{
  "DBClusterIdentifier": "tonys-chips-sandbox-aurora",
  "Engine": "aurora-postgresql",
  "EngineVersion": "15.5",
  "EngineMode": "provisioned",
  "DatabaseName": "tonyschips",
  "MasterUsername": "postgres",
  "ManageMasterUserPassword": true,
  "EnableIAMDatabaseAuthentication": true,
  "EnableHttpEndpoint": true,
  "StorageEncrypted": true,
  "BackupRetentionPeriod": 7,
  "DeletionProtection": false,
  "ServerlessV2ScalingConfiguration": {
    "MinCapacity": 0.5,
    "MaxCapacity": 1
  },
  "DBSubnetGroupName": "subscription to sandbox-tonys-chips-db-subnet-group",
  "VpcSecurityGroupIds": ["subscription to sandbox-tonys-chips-rds-sg"]
}
```

**Key Features:**
- **Serverless v2** with 0.5-1 ACU scaling
- **IAM Authentication** enabled
- **Managed Password** via AWS Secrets Manager
- **Encrypted** at rest
- **Multi-AZ** deployment in private subnets

#### 5. RDS Aurora Instance
**Component:** `sandbox-tonys-chips-aurora-instance` (01K816BMX518FTNG6CD9KB3FEH)
**Schema:** AWS::RDS::DBInstance
**Purpose:** Required instance for Serverless v2 cluster

**Configuration:**
- Instance Class: `db.serverless`
- Links to Aurora cluster

#### 6. RDS Proxy IAM Role
**Component:** `sandbox-rds-proxy-role` (01K818HK1VYCH25DBX1N30PABZ)
**Schema:** AWS::IAM::Role
**Purpose:** Allows RDS Proxy to read database secrets

**Trust Policy:**
```json
{
  "Version": "2012-10-17",
  "Statement": [{
    "Effect": "Allow",
    "Principal": {"Service": "rds.amazonaws.com"},
    "Action": "sts:AssumeRole"
  }]
}
```

#### 7. RDS Proxy Secrets Policy
**Component:** `sandbox-rds-proxy-secrets-policy` (01K818M0Q4S2N5WZPXBJ5Y0RBV)
**Schema:** AWS::IAM::ManagedPolicy
**Purpose:** Grants permissions to read Secrets Manager secrets

**Permissions:**
- `secretsmanager:GetSecretValue`
- `kms:Decrypt`

#### 8. RDS Proxy
**Component:** `sandbox-tonys-chips-rds-proxy` (01K818NC7D1EYWQ5GTS9NDWHHS)
**Schema:** AWS::RDS::DBProxy
**Purpose:** Connection pooling and IAM authentication management

**Configuration:**
```json
{
  "DBProxyName": "tonys-chips-proxy",
  "EngineFamily": "POSTGRESQL",
  "RequireTLS": true,
  "IdleClientTimeout": 1800,
  "VpcSubnetIds": ["subnet-1", "subnet-2"],
  "VpcSecurityGroupIds": ["subscription to sandbox-tonys-chips-rds-sg"],
  "RoleArn": "subscription to sandbox-rds-proxy-role",
  "Auth": [{
    "AuthScheme": "SECRETS",
    "IAMAuth": "REQUIRED",
    "SecretArn": "subscription to Aurora cluster master secret"
  }]
}
```

**Key Features:**
- **IAM Auth Required** - Forces IAM authentication
- **TLS Required** - All connections must use SSL/TLS
- **Connection Pooling** - Manages database connections efficiently
- **Multi-AZ** - Deployed across private subnets

#### 9. RDS Proxy Target Group
**Component:** `sandbox-tonys-chips-proxy-target-group` (01K818R7R3JC4QKX158NNN77H0)
**Schema:** AWS::RDS::DBProxyTargetGroup
**Purpose:** Links RDS Proxy to Aurora cluster

#### 10. ECS Task Role
**Component:** `sandbox-tonys-chips-ecs-task-role` (01K817EY7AJHQC1D97NH33WGYX)
**Schema:** AWS::IAM::Role
**Purpose:** Grants ECS tasks permission to authenticate with RDS

**Trust Policy:**
```json
{
  "Version": "2012-10-17",
  "Statement": [{
    "Effect": "Allow",
    "Principal": {"Service": "ecs-tasks.amazonaws.com"},
    "Action": "sts:AssumeRole"
  }]
}
```

#### 11. RDS IAM Authentication Policy
**Component:** `sandbox-tonys-chips-rds-iam-auth-policy` (01K817FDPNTNETH4Q7V91T519E)
**Schema:** AWS::IAM::ManagedPolicy
**Purpose:** Grants permission to generate IAM auth tokens

**Permissions:**
```json
{
  "Version": "2012-10-17",
  "Statement": [{
    "Effect": "Allow",
    "Action": "rds-db:connect",
    "Resource": "arn:aws:rds-db:us-east-1:*:dbuser:*/*"
  }]
}
```

### Components Updated

#### 12. ECS Task Definition
**Component:** `sandbox-tonys-chips-api-task` (01K7QJEFZQ20CWFVT678H7QGAW)
**Schema:** AWS::ECS::TaskDefinition

**Changes:**
- Added `TaskRoleArn` subscription to ECS task role
- Added environment variables (direct subscriptions, no String Templates):
  - `DB_HOST` → RDS Proxy endpoint
  - `DB_NAME` → "tonyschips"
  - `DB_USER` → "postgres"
  - `DB_PORT` → "5432"
  - `DB_USE_IAM_AUTH` → "true"
- Removed `DATABASE_URL` secret reference

---

## Application Code Changes

### Files Modified

#### 1. `packages/api/package.json`
**Added Dependency:**
```json
{
  "dependencies": {
    "@aws-sdk/rds-signer": "^3.913.0"
  }
}
```

**Installation Command:**
```bash
cd /Users/stack72/code/systeminit/tonys-chips/packages/api
npm install @aws-sdk/rds-signer
```

**Result:** Successfully added 49 packages

---

#### 2. `packages/api/src/config/secrets.ts`

**New Function Added:** `generateIAMAuthToken()`

```typescript
/**
 * Generate an IAM authentication token for RDS Proxy
 * Token is valid for 15 minutes
 */
export async function generateIAMAuthToken(): Promise<string> {
  const host = process.env.DB_HOST;
  const port = parseInt(process.env.DB_PORT || '5432');
  const user = process.env.DB_USER || 'postgres';
  const region = process.env.AWS_REGION || 'us-east-1';

  if (!host) {
    throw new Error('DB_HOST environment variable not set');
  }

  try {
    const signer = new Signer({
      hostname: host,
      port: port,
      username: user,
      region: region
    });

    const token = await signer.getAuthToken();
    console.log('Generated IAM auth token for database connection');
    return token;
  } catch (error) {
    console.error('Failed to generate IAM auth token:', error);
    throw error;
  }
}
```

**Updated Function:** `buildDatabaseUrl()`

```typescript
/**
 * Build the database connection URL
 * Uses IAM authentication when DB_USE_IAM_AUTH=true
 * Falls back to Secrets Manager or DATABASE_URL for local development
 */
export async function buildDatabaseUrl(): Promise<string> {
  const user = process.env.DB_USER || 'postgres';
  const host = process.env.DB_HOST;
  const port = process.env.DB_PORT || '5432';
  const database = process.env.DB_NAME || 'postgres';
  const useIAMAuth = process.env.DB_USE_IAM_AUTH === 'true';

  if (!host) {
    throw new Error('DB_HOST environment variable not set');
  }

  let password: string;

  if (useIAMAuth) {
    // Use IAM authentication (RDS Proxy in production)
    console.log('Using IAM authentication for database connection');
    password = await generateIAMAuthToken();
    // SSL is REQUIRED when using IAM authentication
    return `postgresql://${user}:${password}@${host}:${port}/${database}?schema=public&sslmode=require`;
  } else {
    // Use password from Secrets Manager or environment
    console.log('Using password authentication for database connection');
    if (process.env.DB_PASSWORD) {
      password = process.env.DB_PASSWORD;
    } else {
      password = await getDatabasePassword();
    }
    return `postgresql://${user}:${password}@${host}:${port}/${database}?schema=public`;
  }
}
```

**Key Changes:**
- IAM authentication is **disabled by default** (when `DB_USE_IAM_AUTH` is not set)
- Generates 15-minute IAM tokens using AWS RDS Signer
- Enforces SSL/TLS when using IAM authentication (`sslmode=require`)
- Maintains backward compatibility with password-based authentication
- Supports local development without any changes

---

#### 3. `packages/api/src/index.ts`

**Added:** Graceful shutdown handlers

```typescript
// Graceful shutdown handlers
const gracefulShutdown = async (signal: string) => {
  console.log(`${signal} received, shutting down gracefully`);

  // Stop accepting new connections
  server.close(async () => {
    console.log('HTTP server closed');

    // Disconnect Prisma client
    try {
      await prisma.$disconnect();
      console.log('Database connection closed');
      process.exit(0);
    } catch (error) {
      console.error('Error during database disconnect:', error);
      process.exit(1);
    }
  });

  // Force shutdown after 10 seconds
  setTimeout(() => {
    console.error('Could not close connections in time, forcefully shutting down');
    process.exit(1);
  }, 10000);
};

process.on('SIGTERM', () => gracefulShutdown('SIGTERM'));
process.on('SIGINT', () => gracefulShutdown('SIGINT'));
```

**Added:** Database health check endpoint

```typescript
app.get('/health/db', async (req, res) => {
  try {
    const prisma = await getPrismaClient();
    // Simple query to test database connectivity
    await prisma.$queryRaw`SELECT 1`;
    res.json({
      status: 'healthy',
      database: 'connected',
      authMethod: process.env.DB_USE_IAM_AUTH === 'true' ? 'IAM' : 'password'
    });
  } catch (error) {
    console.error('Database health check failed:', error);
    res.status(503).json({
      status: 'unhealthy',
      database: 'disconnected',
      error: error instanceof Error ? error.message : 'Unknown error'
    });
  }
});
```

**Key Changes:**
- Proper cleanup of database connections on SIGTERM/SIGINT
- 10-second timeout for graceful shutdown
- New `/health/db` endpoint for monitoring database connectivity
- Health check reports authentication method (IAM vs password)

---

#### 4. `packages/api/src/config/database.ts`

**No Changes Required**

The existing code already properly uses `buildDatabaseUrl()` from `secrets.ts`, which now supports IAM authentication.

---

## Environment Variables

### Production (Sandbox) Environment

**Required for IAM Authentication:**
```bash
DB_HOST=<rds-proxy-endpoint>                    # From RDS Proxy
DB_PORT=5432
DB_NAME=tonyschips
DB_USER=postgres
DB_USE_IAM_AUTH=true
AWS_REGION=us-east-1
```

**Set in ECS Task Definition via subscriptions:**
- `DB_HOST` → RDS Proxy `/resource_value/Endpoint`
- `DB_NAME` → Aurora Cluster `/domain/DatabaseName`
- `DB_USER` → Aurora Cluster `/domain/MasterUsername`
- `DB_PORT` → Static value "5432"
- `DB_USE_IAM_AUTH` → Static value "true"

### Local Development Environment

**Option 1: Using DATABASE_URL**
```bash
DATABASE_URL=postgresql://user:password@localhost:5432/database
```

**Option 2: Individual Environment Variables**
```bash
DB_HOST=localhost
DB_PORT=5432
DB_NAME=tonyschips
DB_USER=postgres
DB_PASSWORD=yourpassword
# DB_USE_IAM_AUTH not set (defaults to false)
```

---

## Security Architecture

### Network Security
```
Internet
    ↓
ECS Tasks (sandbox-tonys-chips-api-sg)
    ↓ (Port 5432, TCP only)
RDS Proxy (sandbox-tonys-chips-rds-sg)
    ↓
Aurora Cluster (sandbox-tonys-chips-rds-sg)
```

**Security Layers:**
1. **Network Isolation:** RDS in private subnets only
2. **Security Group Rules:** Database only accessible from API security group
3. **IAM Authentication:** No static passwords, 15-minute token expiry
4. **TLS Required:** All connections encrypted in transit
5. **Encryption at Rest:** Storage encryption enabled

### IAM Permissions Flow
```
ECS Task
  ↓ (uses Task Role)
IAM Auth Token Generation
  ↓ (15-minute token)
RDS Proxy
  ↓ (validates IAM token)
  ↓ (retrieves password from Secrets Manager)
Aurora Cluster
```

---

## Testing & Validation

### Build Verification
```bash
cd /Users/stack72/code/systeminit/tonys-chips/packages/api
npm run build
```

**Result:** ✅ TypeScript compilation successful with no errors

### Health Check Endpoints

**Basic Health Check:**
```bash
GET /health
Response: {"status": "ok"}
```

**Database Health Check:**
```bash
GET /health/db
Response (Healthy): {
  "status": "healthy",
  "database": "connected",
  "authMethod": "IAM"
}

Response (Unhealthy): {
  "status": "unhealthy",
  "database": "disconnected",
  "error": "error message"
}
```

---

## Issues Resolved

### Issue 1: Security Group Creation Failure
**Error:** `Invalid security group description. Valid descriptions are strings less than 256 characters from the following set: a-zA-Z0-9. _-:/()#,@[]+=&;{}!$*`

**Root Cause:** Description contained apostrophe in "Tony's Chips" which is not allowed by AWS

**Resolution:** Changed description from "Tony's Chips" to "Tonys Chips"

### Issue 2: Security Group Already Exists
**Error:** `Security Group with tonys-chips-rds-sg already exists`

**Root Cause:** Security group `sg-03f67b88dbd4ca2bd` was created in a previous failed attempt

**Resolution:**
- Imported existing security group `sg-03f67b88dbd4ca2bd`
- Renamed component to `sandbox-tonys-chips-rds-sg`
- Updated with correct ingress rules

### Issue 3: Missing API Security Group in Sandbox
**Error:** RDS security group referenced non-existent API security group

**Root Cause:** The `tonys-chips-api-sg` existed in production VPC but not in sandbox VPC

**Resolution:**
- Created new `sandbox-tonys-chips-api-sg` in sandbox VPC
- Updated RDS security group to reference the sandbox API security group

### Issue 4: Missing Security Group Subscriptions
**Error:** Components not properly linked to security groups

**Root Cause:** Aurora cluster and RDS Proxy were missing VpcSecurityGroupIds subscriptions

**Resolution:**
- Updated Aurora cluster with subscription to RDS security group
- Updated RDS Proxy with subscription to RDS security group

---

## Deployment Checklist

- [x] Install `@aws-sdk/rds-signer` package
- [x] Update `secrets.ts` with IAM authentication support
- [x] Update `index.ts` with graceful shutdown handlers
- [x] Add database health check endpoint
- [x] Verify TypeScript compilation successful
- [x] Create API security group in sandbox VPC
- [x] Import and configure RDS security group
- [x] Update Aurora cluster with security group subscription
- [x] Update RDS Proxy with security group subscription
- [x] Configure ECS Task Definition environment variables
- [x] Add Task Role to ECS Task Definition
- [ ] Apply change set `import-existing-rds-sg` in System Initiative
- [ ] Verify RDS resources created successfully
- [ ] Deploy updated application code
- [ ] Test `/health/db` endpoint
- [ ] Monitor logs for successful IAM token generation
- [ ] Verify database connectivity from ECS tasks

---

## Rollback Plan

If issues occur after deployment:

1. **Revert Environment Variables:**
   - Set `DB_USE_IAM_AUTH=false`
   - Add back `DATABASE_URL` secret reference in Task Definition
   - Redeploy ECS service

2. **Revert Application Code:**
   ```bash
   git revert <commit-hash>
   npm run build
   # Deploy previous version
   ```

3. **Keep Infrastructure:**
   - RDS resources can remain (won't be used without IAM auth enabled)
   - No need to destroy infrastructure for application rollback

---

## Performance Considerations

### RDS Proxy Benefits
- **Connection Pooling:** Reduces database connection overhead
- **Failover Support:** Automatic failover with no DNS caching issues
- **IAM Token Caching:** Proxy handles token validation and refresh

### Serverless v2 Scaling
- **Min Capacity:** 0.5 ACU (~1GB RAM, moderate CPU)
- **Max Capacity:** 1 ACU (~2GB RAM, moderate CPU)
- **Auto-scaling:** Responds to load automatically
- **Cost Optimization:** Scales down during low usage

---

## Monitoring & Logging

### Application Logs to Watch For
```
✅ "Using IAM authentication for database connection"
✅ "Generated IAM auth token for database connection"
✅ "Database connection initialized"

❌ "Failed to generate IAM auth token"
❌ "Database health check failed"
```

### AWS CloudWatch Metrics
- **RDS Proxy:**
  - `DatabaseConnections`
  - `ClientConnections`
  - `AvailabilityPercentage`

- **Aurora Cluster:**
  - `ServerlessDatabaseCapacity` (should scale between 0.5-1)
  - `DatabaseConnections`
  - `CPUUtilization`

### Health Check Monitoring
- Configure ALB/CloudWatch to monitor `/health/db` endpoint
- Alert on 503 responses
- Alert on authentication method mismatch

---

## Cost Estimate

### RDS Aurora Serverless v2
- **Capacity:** 0.5-1 ACU
- **Storage:** ~10GB initial
- **Backups:** 7 days retention
- **Estimate:** ~$50-80/month

### RDS Proxy
- **vCPU Hours:** 2 vCPUs continuously
- **Estimate:** ~$15-20/month

### Secrets Manager
- **Secrets:** 1 secret (master password)
- **Estimate:** ~$0.40/month

**Total Estimated Cost:** ~$65-100/month

---

## References

### AWS Documentation
- [RDS IAM Database Authentication](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/UsingWithRDS.IAMDBAuth.html)
- [RDS Proxy](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/rds-proxy.html)
- [Aurora Serverless v2](https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/aurora-serverless-v2.html)

### System Initiative
- Change Set: `import-existing-rds-sg` (01K81E9XBWS2FV4W7VVAG7AYN8)
- Workspace: Tony's Chips Production (01K7HDG3BYRAC8E56KJVMFHKG5)

---

## Next Steps

1. **Apply Infrastructure Changes:**
   - Review change set in System Initiative UI
   - Apply `import-existing-rds-sg` to HEAD
   - Monitor action queue for successful resource creation

2. **Deploy Application:**
   - Build and push new Docker image with updated code
   - Update ECS service to use new task definition
   - Monitor deployment progress

3. **Verify Deployment:**
   - Test `/health/db` endpoint
   - Review CloudWatch logs for IAM auth messages
   - Run smoke tests against API

4. **Post-Deployment:**
   - Monitor RDS Proxy metrics
   - Monitor Aurora scaling behavior
   - Set up alerts for database health check failures

---

**Build Log Created:** October 20, 2025
**Author:** Claude Code
**Status:** Ready for Deployment
