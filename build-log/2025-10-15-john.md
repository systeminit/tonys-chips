# ECR Pull-Through Cache Implementation

**Author**: john@familywatson.co.uk

## Summary

Implemented ECR pull-through cache repositories in the sandbox AWS account to cache images from shared-prod ECR repositories. After multiple failed attempts due to confusion between `CredentialArn` and `CustomRoleArn` fields, successfully configured cross-account ECR pull-through caching for both web and api components.

## Changes Made

- **Files Modified**: None (System Initiative infrastructure only)
- **Files Created**: None 
- **Files Deleted**: None
- **Infrastructure Modified**: 
  - Updated shared-prod ECR repository policies with cross-account permissions
  - Enhanced IAM roles and policies for pull-through cache authentication
- **Infrastructure Created**: 
  - ECR pull-through cache rules: `tonys-chips-web-pull-through-cache`, `tonys-chips-api-pull-through-cache`
  - IAM role: `ecr-pull-through-cache-service-role` 
  - IAM policy: `ecr-pull-through-cache-service-policy`
- **Infrastructure Deleted**: 
  - Multiple failed/duplicate components during troubleshooting

## Technical Decisions

**Key Decision**: Use `CustomRoleArn` instead of `CredentialArn` for cross-account ECR authentication
- `CredentialArn` is for Secrets Manager secrets (external registries like Docker Hub)
- `CustomRoleArn` is for IAM roles (cross-account ECR scenarios)
- This distinction was not clearly documented and caused significant debugging time

**IAM Trust Policy**: Required dual principals for cross-account ECR pull-through cache:
- `pullthroughcache.ecr.amazonaws.com` - ECR service principal
- `arn:aws:iam::839690184014:root` - Upstream account (shared-prod)

**Repository Policies**: Added comprehensive ECR permissions to shared-prod repositories:
- Standard pull permissions: `BatchCheckLayerAvailability`, `BatchGetImage`, `GetDownloadUrlForLayer`
- Pull-through cache specific: `BatchImportUpstreamImage`, `GetImageCopyStatus`

## Issues Encountered

**Major Issue**: Field name confusion between `CredentialArn` and `CustomRoleArn`
- Spent significant time trying to make IAM role ARNs work with `CredentialArn`
- `CredentialArn` has strict Secrets Manager pattern validation that rejects IAM role ARNs
- AWS documentation mentions IAM roles for cross-account ECR but doesn't clearly distinguish field names
- **Resolution**: User identified the correct field (`CustomRoleArn`) after multiple failed attempts

**Authentication Errors**: Multiple failed attempts with various authentication approaches
- Tried removing credentials entirely (failed - still required authentication)
- Tried different IAM role configurations (failed due to wrong field)
- **Resolution**: Proper IAM role with correct trust policy + using `CustomRoleArn`

## Prompts

```prompt
Right, now I need another ECR Repository in the sandbox account for each web and api like I have in shared-prod but I want them to be pull-through cache's

upstream is another ecr repo (in shared-prod) not dockerhub

Do I need to do any IAM authentication stuff to allow the pull through to happen?

Investigate the failed actions on HEAD and propose the fix

Look at the failed actions and try again

Can we not name things "v2" I'd rather clean up what failed (if we have no intention to use it) or fix the existing failed one and retry the create

is it correct that all those CREATE actions are in sandbox? Like do we just need to apply role changes to the pull-through cache repos? I was expecting to have to make a change to the source repos (in shared-prod) too, but maybe we've already done that

Ok I applied that. There are some failures on HEAD actions, can you investigate and propose the fix?

Ok - recheck HEAD, all the change sets are merged

Ok, the problem here was that we needed to use Custom Role Arn, not Credential Arn, I've fixed it and applied to HEAD

This was torture. Please do better next time.

write out the log file I need for this context window/the work today
```

## Next Steps

- Monitor pull-through cache performance and costs
- Consider implementing similar caching for other environments if beneficial
- Document the `CustomRoleArn` vs `CredentialArn` distinction for future reference
- Validate that images are properly cached from shared-prod when pulled in sandbox account