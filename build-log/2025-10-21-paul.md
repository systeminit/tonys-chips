# Service Discovery & Deployment Improvements - Build Log

**Date:** October 21, 2025
**Change Sets:**
- `update-smoke-test-to-use-e2e`
- `migrate-to-service-discovery`
- `recreate-api-service-with-service-discovery`
- `fix-smoke-test-urls`
- `scale-up-api-and-update-web-service`
- `fix-health-checks-use-nodejs`
- `fix-step-functions-graceful-deployment`

**Status:** Completed

---

## Overview

This build log documents a major architectural shift from ALB-based internal service communication to AWS Service Discovery (Cloud Map), along with critical fixes for ECS health checks, Step Functions deployment strategy, and database seeding. The changes enable zero-downtime deployments and proper service-to-service communication.

---

## Phase 1: Service Discovery Migration

### Problem Statement
- API service was registered with ALB for both external and internal traffic
- Web service was calling API through ALB (`http://internal-alb:3000`)
- Inefficient routing for internal service-to-service communication
- Unnecessary ALB overhead and costs for internal calls

### Solution: AWS Service Discovery (Cloud Map)

#### Components Created

**1. Service Discovery Stack (CloudFormation)**
- **Component:** `sandbox-tonys-chips-service-discovery-stack`
- **Schema:** AWS::CloudFormation::Stack
- **Reason:** Native AWS::ServiceDiscovery schemas have no actions in System Initiative

**CloudFormation Template:**
```json
{
  "Resources": {
    "PrivateDnsNamespace": {
      "Type": "AWS::ServiceDiscovery::PrivateDnsNamespace",
      "Properties": {
        "Name": "tonys-chips.local",
        "Vpc": "vpc-0bc7327e9bc2204c2"
      }
    },
    "ServiceDiscoveryService": {
      "Type": "AWS::ServiceDiscovery::Service",
      "Properties": {
        "Name": "api",
        "DnsConfig": {
          "DnsRecords": [{"Type": "A", "TTL": 60}],
          "NamespaceId": {"Fn::GetAtt": ["PrivateDnsNamespace", "Id"]}
        },
        "HealthCheckCustomConfig": {"FailureThreshold": 1}
      }
    }
  },
  "Outputs": {
    "ServiceDiscoveryArn": {
      "Value": {"Fn::GetAtt": ["ServiceDiscoveryService", "Arn"]}
    }
  }
}
```

**Output:** `arn:aws:servicediscovery:us-east-1:600751737951:service/srv-6srnbva6jqhp7ep6`

#### API Service Configuration

**Updated:** `sandbox-tonys-chips-api-service`

**Key Changes:**
```json
{
  "ServiceRegistries": [{
    "RegistryArn": {
      "$source": {
        "component": "sandbox-tonys-chips-service-discovery-stack",
        "path": "/resource_value/Outputs/3/OutputValue"
      }
    }
  }],
  "LoadBalancers": []  // Removed ALB registration
}
```

**Critical Discovery:** ECS `ServiceRegistries` is **immutable** - cannot be added to existing service
- **Solution:** Deleted and recreated API service with ServiceRegistries configured

#### Web Task Configuration

**Updated:** `sandbox-tonys-chips-web-task`

**Environment Variable Change:**
```json
{
  "Environment": [
    {
      "Name": "API_URL",
      "Value": "http://api.tonys-chips.local:3000"
    }
  ]
}
```

#### Security Group Updates

**Updated:** `sandbox-tonys-chips-api-sg-v2`

**Added Self-Referencing Rule:**
```json
{
  "SecurityGroupIngress": [
    {
      "IpProtocol": "tcp",
      "FromPort": 3000,
      "ToPort": 3000,
      "SourceSecurityGroupId": "(self-reference)",
      "Description": "Allow internal service-to-service communication on port 3000"
    }
  ]
}
```

#### Deleted Components
- `sandbox-tonys-chips-api-listener-rule` (ALB listener for /api/*)
- `sandbox-tonys-chips-api-tg` (ALB target group)

---

## Phase 2: Health Check Fixes

### Problem Statement
- ECS task health checks were failing with "wget: not found"
- Docker images use `node:20-alpine` which doesn't include `wget`
- Tasks were failing health checks and constantly restarting

### Solution: Node.js Built-in HTTP Module

#### Health Check Changes

**API Task Definition:**
```json
{
  "HealthCheck": {
    "Command": [
      "CMD-SHELL",
      "node -e \"require('http').get('http://localhost:3000/health', (res) => process.exit(res.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))\""
    ],
    "Interval": 30,
    "Retries": 3,
    "StartPeriod": 60,
    "Timeout": 5
  }
}
```

**Web Task Definition:**
```json
{
  "HealthCheck": {
    "Command": [
      "CMD-SHELL",
      "node -e \"require('http').get('http://localhost:3001/health', (res) => process.exit(res.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))\""
    ],
    "Interval": 30,
    "Retries": 3,
    "StartPeriod": 60,
    "Timeout": 5
  }
}
```

**Benefits:**
- Node.js is guaranteed to be available in containers
- No external dependencies (wget, curl)
- Actually validates the `/health` endpoint responds correctly
- Works on Alpine Linux base images

---

## Phase 3: Step Functions Graceful Deployment

### Problem Statement
- Step Functions deployment pipeline was setting `DesiredCount: 2` explicitly
- Caused services to scale down to 0 then back up to 2 on every deployment
- **Zero downtime deployments were impossible**
- User-configured scaling (e.g., scaling to 4 for high traffic) was overridden

### Solution: Remove Hardcoded DesiredCount

**Component Updated:** `sandbox-step-functions-definition` (String Template)

**Before:**
```json
{
  "UpdateAPIService": {
    "Type": "Task",
    "Resource": "arn:aws:states:::aws-sdk:ecs:updateService",
    "Parameters": {
      "Cluster": "tonys-chips-sandbox",
      "Service": "sandbox-tonys-chips-api",
      "TaskDefinition": "sandbox-tonys-chips-api",
      "DesiredCount": 2,  // ❌ Forces count, kills existing tasks
      "ForceNewDeployment": true
    }
  }
}
```

**After:**
```json
{
  "UpdateAPIService": {
    "Type": "Task",
    "Resource": "arn:aws:states:::aws-sdk:ecs:updateService",
    "Parameters": {
      "Cluster": "tonys-chips-sandbox",
      "Service": "sandbox-tonys-chips-api",
      "TaskDefinition": "sandbox-tonys-chips-api",
      "ForceNewDeployment": true  // ✅ Maintains current DesiredCount
    }
  }
}
```

**Result:**
- ECS performs **rolling deployment** using configured deployment strategy
- `MaximumPercent: 200` allows doubling capacity during deployment
- `MinimumHealthyPercent: 50` ensures half the tasks stay healthy
- New tasks start → health checks pass → old tasks drain → old tasks stop
- **Zero downtime deployments achieved**

---

## Phase 4: Database Seeding Migration

### Problem Statement
- Initial attempt: TypeScript `seed.ts` file run separately from migrations
- Issue: Seed script wasn't using IAM authentication properly
- Issue: API containers were exiting after migrations instead of starting app
- Idempotency checks required in application code
- Seed data not version controlled with schema

### Evolution of Solutions

#### Attempt 1: Run seed in docker-entrypoint.sh
```bash
# docker-entrypoint.sh
npm run db:seed  # Failed - no IAM auth
```
**Problem:** Seed used `new PrismaClient()` without IAM-authenticated DATABASE_URL

#### Attempt 2: Create run-seed.js with IAM auth
```javascript
// scripts/run-seed.js
const databaseUrl = await buildDatabaseUrl();
execSync('npx tsx prisma/seed.ts', {
  env: { ...process.env, DATABASE_URL: databaseUrl }
});
```
**Problem:** API containers exiting after migrations, seed not running

#### Attempt 3: Run seed in migrations task
```javascript
// scripts/run-migrations.js
execSync('npx prisma migrate deploy');
execSync('npx tsx prisma/seed.ts');  // Added
```
**Problem:** Better separation, but still TypeScript-based, not tracked by Prisma

#### Final Solution: Data Migration (SQL)

**Created:** `packages/api/prisma/migrations/20251021000000_seed_products/migration.sql`

```sql
-- Seed initial product data
-- Using hardcoded UUIDs to avoid dependency on pgcrypto extension

INSERT INTO "Product" ("id", "name", "brand", "description", "price", "imageUrl", "stockQuantity", "createdAt", "updatedAt")
VALUES
  ('550e8400-e29b-41d4-a716-446655440001', 'Classic Potato Chips', 'Lay''s', 'America''s favorite classic potato chips with a simple, satisfying crunch and salt.', 3.99, 'https://placehold.co/400x400/e3f2fd/1565c0?text=Lays+Classic', 50, NOW(), NOW()),
  ('550e8400-e29b-41d4-a716-446655440002', 'Sour Cream & Onion', 'Lay''s', 'Creamy and tangy sour cream flavor mixed with savory onion.', 3.99, 'https://placehold.co/400x400/f3e5f5/7b1fa2?text=Lays+SC%26O', 45, NOW(), NOW()),
  -- ... (12 products total)
ON CONFLICT DO NOTHING;
```

**Benefits:**
✅ Tracked by Prisma migrations table - runs exactly once
✅ Transactional - rolls back if migration fails
✅ Version controlled with schema changes
✅ No idempotency checks needed in code
✅ No IAM auth complexity - uses same connection as migrations
✅ Standard SQL - no language-specific dependencies

**Cleanup Completed:**
- Deleted `packages/api/prisma/seed.ts`
- Removed `"db:seed"` script from `package.json`
- Removed `"prisma": {"seed": "..."}` configuration
- Updated documentation in `README.md` and `MIGRATIONS.md`

---

## Phase 5: Smoke Test Configuration

### Updates Made

**Component:** `sandbox-tonys-chips-smoke-test-task`

**Environment Variables:**
```json
{
  "Environment": [
    {
      "Name": "API_URL",
      "Value": "http://api.tonys-chips.local:3000"
    },
    {
      "Name": "WEB_URL",
      "Value": {
        "$source": {
          "component": "sandbox-tonys-chips-alb",
          "path": "/resource_value/DNSName"
        }
      }
    }
  ]
}
```

**Container Command:**
```json
{
  "Command": ["npm", "run", "test:e2e"]
}
```

---

## Technical Challenges & Solutions

### Challenge 1: ServiceRegistries Immutability
**Problem:** Cannot add `ServiceRegistries` to existing ECS service
**Error:** "ECS Deployment hook execution failure(s) detected"
**Solution:** Delete and recreate service with ServiceRegistries configured from start

### Challenge 2: CloudFormation Stack Output Access
**Initial Assumption:** Outputs not accessible for subscriptions
**Discovery:** Outputs ARE accessible at `/resource_value/Outputs/N/OutputValue`
**Solution:** Direct subscription to CloudFormation Stack output

### Challenge 3: Container Health Check Failures
**Problem:** Alpine Linux lacks `wget` command
**Solution:** Use Node.js built-in HTTP module for health checks

### Challenge 4: Step Functions Killing Services
**Problem:** Hardcoded DesiredCount causing service restart on every deployment
**Solution:** Remove DesiredCount parameter, use ForceNewDeployment only

### Challenge 5: Database Seed Execution
**Problem:** TypeScript seed not running with IAM authentication
**Solution:** Convert to SQL migration tracked by Prisma

---

## Architecture Decisions

### Service Discovery vs ALB
**Decision:** Use Service Discovery for internal API communication
**Rationale:**
- DNS-based resolution (api.tonys-chips.local:3000)
- Client-side load balancing
- Lower latency (direct container-to-container)
- Reduced costs (no ALB data processing fees)
- ALB still used for public web traffic

### Health Check Strategy
**Decision:** Keep both container and ALB health checks
**Rationale:**
- Container health check → ECS restart decisions
- ALB health check → Traffic routing decisions
- Defense in depth approach

### Seeding Strategy
**Decision:** SQL data migration instead of application-based seed
**Rationale:**
- Prisma tracks execution automatically
- Transactional consistency
- Version controlled with schema
- No special handling needed

---

## Files Modified

### Application Code
- `packages/api/docker-entrypoint.sh` - Removed seed execution
- `packages/api/scripts/run-migrations.js` - Simplified to just migrations
- `packages/api/package.json` - Removed seed scripts
- `packages/api/prisma/migrations/20251021000000_seed_products/migration.sql` - New data migration

### Documentation
- `README.md` - Updated seeding instructions
- `packages/api/MIGRATIONS.md` - Updated migration workflow documentation

### System Initiative Components
- `sandbox-tonys-chips-service-discovery-stack` (CloudFormation Stack)
- `sandbox-tonys-chips-api-service` (recreated with ServiceRegistries)
- `sandbox-tonys-chips-api-task` (health check updated)
- `sandbox-tonys-chips-web-task` (API_URL and health check updated)
- `sandbox-tonys-chips-smoke-test-task` (URLs and command updated)
- `sandbox-tonys-chips-api-sg-v2` (self-referencing rule added)
- `sandbox-step-functions-definition` (removed DesiredCount)

---

## Deployment Notes

### Step Functions Deployment Flow
1. **RunMigrations** - Runs migrations task (includes seed migration)
2. **DeployServices** - Updates API and Web services in parallel (graceful rolling deployment)
3. **WaitForHealthy** - 60 second wait for health checks
4. **RunSmokeTests** - Validates deployment with e2e tests

### Service Discovery DNS
- **Namespace:** `tonys-chips.local` (Route 53 private hosted zone)
- **Service:** `api.tonys-chips.local` (A record, TTL 60s)
- **Resolution:** ECS tasks register/deregister automatically
- **Client:** Web service uses DNS for API discovery

### Zero-Downtime Deployment Verification
1. Service maintains current DesiredCount
2. New tasks start with new task definition revision
3. Health checks validate new tasks (60s start period + 30s interval)
4. ECS begins routing to new tasks
5. Old tasks receive SIGTERM, gracefully shutdown
6. Old tasks stopped after draining

---

## Testing & Validation

### Health Check Validation
```bash
# Inside container
node -e "require('http').get('http://localhost:3000/health', (res) => console.log(res.statusCode))"
# Expected: 200
```

### Service Discovery Validation
```bash
# From Web container
nslookup api.tonys-chips.local
# Expected: Returns API task IP addresses

curl http://api.tonys-chips.local:3000/health
# Expected: {"status":"ok"}
```

### Migration Validation
```sql
-- Check migration tracking
SELECT * FROM "_prisma_migrations"
WHERE migration_name = '20251021000000_seed_products';

-- Check seed data
SELECT COUNT(*) FROM "Product";
-- Expected: 12
```

---

## Lessons Learned

1. **Always check AWS service limitations** - ServiceRegistries is immutable, required service recreation
2. **CloudFormation Stacks as data sources** - Outputs accessible via `/resource_value/Outputs/N/OutputValue`
3. **Container base images matter** - Alpine requires careful consideration of available utilities
4. **Data migrations are superior to seed scripts** - Tracked, transactional, version controlled
5. **DesiredCount should rarely be hardcoded** - Let ECS maintain current scaling decisions
6. **Step Functions for orchestration** - Not for forcing infrastructure state

---

## Next Steps

1. Monitor Service Discovery TTL and adjust if needed (currently 60s)
2. Consider adding CloudWatch alarms for Service Discovery health
3. Evaluate adding Redis for session storage (currently using MemoryStore)
4. Consider adding Application Load Balancer access logs for Web traffic analysis
5. Implement proper secrets rotation for SESSION_SECRET

---

## References

- AWS Service Discovery Documentation: https://docs.aws.amazon.com/cloud-map/
- ECS Service Discovery Integration: https://docs.aws.amazon.com/AmazonECS/latest/developerguide/service-discovery.html
- ECS Deployment Configuration: https://docs.aws.amazon.com/AmazonECS/latest/developerguide/service_definition_parameters.html#sd-deploymentconfiguration
- Prisma Migrations: https://www.prisma.io/docs/concepts/components/prisma-migrate
- Alpine Linux Packages: https://pkgs.alpinelinux.org/packages

---

**Build completed successfully** ✅
