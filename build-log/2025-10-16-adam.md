# Fix Infrastructure Flags CI Check Integration

**Author**: adam@systeminit.com

## Summary

Fixed the Infrastructure Flags CI check script to properly integrate with the System Initiative TypeScript SDK. The script now correctly validates infrastructure requirements against deployed flags in System Initiative and posts detailed feedback to GitHub PRs for both passing and failing checks. This enables automated infrastructure readiness verification before deployments to any environment.

## Changes Made

- **Files Modified**:
  - `ci/commands/check-infraflags.ts` - Complete refactor to fix SDK integration, add GitHub PR commenting
  - `.github/workflows/infra-check.yml` - Added PR number input, GitHub token, and pull-requests: write permission
  - `.github/workflows/pr-ci.yml` - Pass PR number to infra-check workflow

- **Files Created**: None

- **Files Deleted**: None

- **Infrastructure Modified**: None

- **Infrastructure Created**: None

- **Infrastructure Deleted**: None

## Technical Decisions

1. **Switched to SearchApi**: Changed from `ComponentsApi.searchComponents` to `SearchApi.search` because the latter returns properly structured `ComponentSearchResult` objects with component IDs, names, and schema information, while the former returns raw arrays.

2. **Manual Authorization Header**: Set the Authorization header manually in `baseOptions.headers` instead of using the `apiKey` parameter, as the SDK was not properly handling Bearer token authentication through the apiKey field.

3. **Component Attributes Parsing**: Parse the flag mapping from `/code/environmentFlagMapping/code` attribute path, which contains the JSON-serialized code generation output with the byEnvironment and byFlag mappings.

4. **Bidirectional PR Comments**: Post comments for both success and failure cases to provide complete visibility. Success comments update any existing failure comments to show infrastructure is ready, preventing confusion about outdated failures.

5. **SI URL Format**: Use the correct System Initiative URL pattern `/n/{workspace}/{changeset}/h/{component}/c` rather than the simpler but incorrect `/w/{workspace}/head/c/{component}` format.

## Issues Encountered

1. **API Call Shape Mismatch**
   - Problem: `listChangeSets(workspaceId)` failed with "Required parameter workspaceId was null or undefined"
   - Root Cause: SDK methods expect request objects, not direct parameters
   - Solution: Changed to `listChangeSets({ workspaceId })`

2. **Authentication 401 Errors**
   - Problem: All API calls returned 401 Forbidden
   - Root Cause: Using `apiKey` parameter with "Bearer " prefix, but SDK wasn't recognizing it
   - Solution: Set Authorization header directly in `baseOptions.headers`

3. **Search Results Structure**
   - Problem: ComponentsApi.searchComponents returned `Array<Array<string>>` which couldn't be parsed
   - Root Cause: Wrong API endpoint - components/search returns tabular data
   - Solution: Use top-level SearchApi which returns structured ComponentSearchResult objects

4. **Missing Component Attributes**
   - Problem: Component had undefined name and id fields
   - Root Cause: Parsing code was looking in wrong structure (domainProps, codegenProps)
   - Solution: Access `/code/environmentFlagMapping/code` directly from attributes object

5. **GitHub 403 Errors**
   - Problem: "Resource not accessible by integration" when posting PR comments
   - Root Cause: Workflow lacked pull-requests: write permission
   - Solution: Added permission to infra-check.yml

6. **Wrong SI Component URL**
   - Problem: Generated URLs didn't match the actual System Initiative URL pattern
   - Root Cause: Incorrect URL format with /w/ prefix and hardcoded "head"
   - Solution: Use correct /n/{workspace}/{changeset}/h/{component}/c format with actual changeset ID

## Prompts

```prompt
Initial request: "this is in ../tonys-chips and the workspace id is being passed correctly"

The check infrastructure flags is failing with the following error:
üîç Checking infrastructure flags for environment: sandbox
üìã Application: tonys-chips
üìù Required flags: baseline
üîç Finding HEAD change set...
‚ùå InfraFlags check failed with error:
Failed to find HEAD change set: RequiredError: Required parameter workspaceId was null or undefined when calling listChangeSets.

Follow-up: "I think the API call is the wrong shape"

Follow-up: "fix the check-infraflags.ts"

Follow-up: "we should be able to use the 'search' interface, which will return a list of component ids. the query would be `schema:"SI::CD::InfraFlags" application:"tonys-chips"` where the application is the application name passed in to the script. then you can use component get to..."

Follow-up: "for the analysis, you can use json.parse on the "/code/environmentFlagMapping/code" attribute to get this data structure: [provided example JSON]"

Follow-up: "change the output so that it removes the 'with code generation output' line. then make it so that if the check fails, it posts a reply to the github pull request (if there is one) that says which flags are missing and has a link to the InfraFlags component"

Follow-up: "in next steps, step 1 should be: 'implement the required infrastructure for the environment (or environments)', then the rest of the steps."

Follow-up: "https://app.systeminit.com/n/01K7HDG3BYRAC8E56KJVMFHKG5/01K7HE4W8EQN4RJGC8M6TTGMPA/h/01K7MP6SKH7JBP81NFES1BJP95/c < is an example of the right style of url - workspace, change set, component are the ulids"

Follow-up: [403 error when posting to PR - "Resource not accessible by integration"]

Final: "when the flags are passing, we should update the comment if it exists to say that all infrastructure flags are passing"
```

## Next Steps

None - the infrastructure flags check is now fully functional with:
- ‚úÖ Correct SDK integration
- ‚úÖ Proper authentication
- ‚úÖ Component search and attribute parsing
- ‚úÖ GitHub PR commenting for both success and failure
- ‚úÖ Correct System Initiative URLs
- ‚úÖ Proper permissions configured
