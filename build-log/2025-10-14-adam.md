# Improved Build Log Prompt Template

**Author**: adam@systeminit.com

## Summary

Enhanced the build-log/prompt.md file to provide clearer guidance for generating session summaries. The original template was minimal and lacked important context and structure.

## Changes Made

- **Files Modified**: `/home/adam/src/tonys/tonys-chips/build-log/prompt.md`

## Technical Decisions

**Why these improvements were made:**
- Added title and purpose statement to clarify the document's intent
- Included placeholder definitions with concrete examples to reduce ambiguity
- Added date format example (YYYY-MM-DD) to prevent formatting inconsistencies
- Expanded template structure with sections for Changes Made, Technical Decisions, Issues Encountered, and Next Steps
- Specified behavior for existing files (append mode) to avoid confusion
- Added Best Practices section to guide quality summary writing

**Rationale:**
The original prompt was too terse and assumed users understood the context and placeholders. The improved version provides comprehensive guidance while remaining easy to follow.

## Issues Encountered

None - straightforward documentation improvement.

## Prompts

```prompt
suggest improvements to the build-logs/prompt.md
```

```prompt
it's in ../tonys-chips
```

```prompt
yes [to rewriting the entire prompt]
```

```prompt
@../tonys-chips/build-log/prompt.md and summarize this session
```

```prompt
update the prompt.md to also include the user who made the change (use the current git configured email)
```

```prompt
now update the existing summary to include the email appropriately
```

## Next Steps

None - the prompt template is now comprehensive and ready for use.

---

# Created Infrastructure Management Guide

**Author**: adam@systeminit.com

## Summary

Created a comprehensive INFRA.md file for the tonys-chips project that establishes naming conventions, AWS tagging policies, and System Initiative workflow guidance. This document serves as the authoritative reference for infrastructure management standards across the project.

## Changes Made

- **Files Created**: `/home/adam/src/tonys/tonys-chips/INFRA.md`

## Technical Decisions

**Naming Conventions:**
- Established kebab-case as the primary naming convention with lowerCamelCase as fallback
- Required Name tags to match si/name for consistency across infrastructure and UI

**AWS Tagging Policy:**
- Defined five required tags for all AWS resources: Environment, Owner, CostCenter, Application
- Standardized on PascalCase for tag keys
- Created approved value lists for Environment (Sandbox, Shared, Dev, PreProd, Prod) and CostCenter (ProjectApollo, ProjectOrigin, CustomerPortal, DevelopmentSandbox, TestingQA)
- Established DevelopmentSandbox as default CostCenter for unallocated resources

**Enforcement Strategy:**
- Documented consequences for non-compliance (automatic stops, creation denials, audit flagging)
- Emphasized team accountability for tag accuracy
- Highlighted financial impact through chargeback mechanisms

**System Initiative Integration:**
- Documented Change Set workflow (create → make changes → check qualifications → apply → monitor actions)
- Provided component configuration examples with proper subscription patterns
- Established best practices for validation and tag management

**Rationale:**
This document ensures consistency across the team, enables accurate cost allocation, and provides clear guidance for both new and experienced users working with System Initiative and AWS infrastructure.

## Issues Encountered

**Initial Environment Values:**
User corrected the Environment tag values from the initial set (Production, Staging, Development, Sandbox) to the correct organizational standard (Sandbox, Shared, Dev, PreProd, Prod) before the file was created.

## Prompts

```prompt
add a ../tonys-chips/INFRA.md file with guidance for working with System Initiative to build and manage infrastructure for the project. it should specify that we name things with kebab-case where possible, lower camel where that is not permitted, use Name tags when we need them that should match the si/name, and this tag policy: Every AWS resource must include the following tags at minimum:
- Environment (Production, Staging, Development, Sandbox)
- Owner (email responsible, initially set to creator email if unknown)
- CostCenter (internal accounting reference). One of:
    - ProjectApollo
    - ProjectOrigin
    - CustomerPortal
    - DevelopmentSandbox
    - TestingQA
  Default to DevelopmentSandbox for unallocated or unknown cases.
- Application (service, product, or project name) Create new name if unallocated or unknown cases

** Standardized Tag Keys and Values **
- All tag keys must use PascalCase (e.g., CostCenter, Application).
- All tag values must come from an approved list where applicable (e.g., Environment must be one of: Production, Staging, Development, Sandbox).

Free-form tags may be used for special cases, but should not conflict with organizational tags.

Resources without required tags may be automatically stopped, denied creation, or flagged for remediation.

Teams are accountable for maintaining tag accuracy; stale or incorrect tags will be flagged during audits.

Cost Allocation and Chargeback - The CostCenter tag is required on all billable resources (EC2, RDS, S3 buckets, Lambda, etc.). Untagged resources may be assigned to a default CostCenter and subject to higher internal chargeback rates.
```

```prompt
environments should be Sandbox, Shared, Dev, PreProd, Prod
```

## Next Steps

- Apply these standards to existing infrastructure in System Initiative
- Create example components demonstrating proper tag configuration
- Consider adding validation scripts or policies to enforce tagging requirements
- Document any project-specific Application names as they are created

---

# Discovered Default AWS Infrastructure

**Author**: adam@systeminit.com

## Summary

Discovered and imported all default AWS infrastructure components in the us-east-1 region into System Initiative. This included the default VPC, all six default subnets (one per availability zone), the internet gateway, route table, and default security group. All components were renamed following the `sandbox-default-*` naming convention for clear identification.

## Changes Made

- **Infrastructure Created**:
  - `sandbox-default-vpc` (AWS::EC2::VPC)
  - `sandbox-default-subnet-us-east-1a` (AWS::EC2::Subnet)
  - `sandbox-default-subnet-us-east-1b` (AWS::EC2::Subnet)
  - `sandbox-default-subnet-us-east-1c` (AWS::EC2::Subnet)
  - `sandbox-default-subnet-us-east-1d` (AWS::EC2::Subnet)
  - `sandbox-default-subnet-us-east-1e` (AWS::EC2::Subnet)
  - `sandbox-default-subnet-us-east-1f` (AWS::EC2::Subnet)
  - `sandbox-default-internet-gateway` (AWS::EC2::InternetGateway)
  - `sandbox-default-route-table` (AWS::EC2::RouteTable)
  - `sandbox-default-security-group` (AWS::EC2::SecurityGroup)

## Technical Decisions

**Discovery vs Import Approach:**
- Used `component-discover` for VPC, Subnets, and Internet Gateway (succeeded without refinement)
- For RouteTable and SecurityGroup, the discover function required `/domain/VpcId` refinement parameter
- Discovery function succeeded but didn't automatically create components, so used `component-import` with resource IDs from function logs

**VpcId Refinement Requirement:**
- Both `AWS::EC2::RouteTable` and `AWS::EC2::SecurityGroup` schemas require the `/domain/VpcId` attribute to be set as a subscription to the VPC's `/resource_value/VpcId` for successful discovery
- This filtering ensures we only discover resources associated with the specific VPC

**Naming Strategy:**
- Used `sandbox-default-*` prefix to clearly indicate these are default AWS resources in the sandbox environment
- Subnet names include availability zone suffix for easy identification (e.g., `sandbox-default-subnet-us-east-1a`)
- Follows the kebab-case convention established in INFRA.md

## Issues Encountered

**Route Table Discovery Failure:**
- Initial discovery attempt failed with error: "Cannot read properties of undefined (reading 'find')"
- Root cause: Missing required `/domain/VpcId` refinement parameter
- Solution: Updated discover component with VpcId subscription before running discovery
- Same pattern applied successfully to SecurityGroup discovery

**Component Creation Not Automatic:**
- Discovery management functions returned success and found resources, but didn't automatically create the components in the workspace
- Function logs showed the resource data and creation specifications
- Workaround: Used `component-import` with the resource IDs identified in the function logs to directly import the components

## Prompts

```prompt
discover the default AWS infrastructure, and name all the resulting components 'sandbox-default-whatever', where 'whatever' is representative of their function
```

```prompt
look at the failed action for discovering the route table, and update the Discover component for the route tables with the correct refinement
```

```prompt
now do the same for security group
```

## Next Steps

- Apply the change set to HEAD to make these components visible in production
- Add required tags (Environment, Owner, CostCenter, Application) to all discovered components per INFRA.md standards
- Review and document the default VPC configuration (CIDR blocks, routing, security rules)
- Consider whether to keep using default VPC or create custom VPC with proper naming and tagging

---

# AWS EC2 Infrastructure Setup for Tony's Chips Application

**Author**: adam@systeminit.com

## Summary

Built complete AWS EC2 infrastructure in System Initiative to deploy the Tony's Chips application stack (web app, API, and PostgreSQL database) using Docker containers. Created all required AWS resources including EC2 instance, security groups, SSH keys, and AMI lookup components across three change sets. The infrastructure was designed to run the application on a t3.small instance with automated deployment via cloud-init user-data.

## Changes Made

- **Files Modified**: None
- **Files Created**: None
- **Files Deleted**: None

### Infrastructure Created in System Initiative

**Change Set: tonys-chips-ec2-setup**
- **tonys-chips-amazon-linux-ami** (AWS::EC2::AMI) - AMI lookup for latest Amazon Linux 2
- **tonys-chips-ssh-key** (AWS::EC2::KeyPair) - SSH key pair for instance access
- **tonys-chips-api-sg** (AWS::EC2::SecurityGroup) - Security group allowing SSH (port 22) and HTTP (port 80)
- **tonys-chips-api-server** (AWS::EC2::Instance) - t3.small EC2 instance with user-data script

**Change Set: update-security-group-port-8080**
- Modified security group ingress rule from port 80 to port 8080 to match docker-compose web app configuration

**Change Set: fix-user-data-script**
- Updated EC2 instance user-data script to properly execute via cloud-init

### Infrastructure Modified

- Security group description updated to remove apostrophe (AWS character restriction)
- Security group ingress rule updated from HTTP (port 80) to web app port (8080)
- EC2 instance user-data script significantly revised for proper execution

## Technical Decisions

### Instance Type Selection
- **Decision**: Use t3.small instance type
- **Rationale**: As specified in requirements, provides adequate resources for running Docker containers with web app, API, and PostgreSQL

### Security Group Configuration
- **Decision**: Allow SSH (port 22) from anywhere (0.0.0.0/0) and port 8080 for web app
- **Rationale**: Port 8080 matches the docker-compose.yml configuration which maps container port 3001 to host port 8080. SSH access needed for debugging and key retrieval.

### Network Configuration
- **Decision**: Use existing sandbox VPC and default subnet in us-east-1a
- **Rationale**: Reuse existing infrastructure rather than creating new VPC, faster deployment

### AMI Selection
- **Decision**: Use AWS::EC2::AMI component to dynamically find latest Amazon Linux 2 AMI
- **Rationale**: Ensures instance always uses the most up-to-date AMI with security patches, filters for `amzn2-ami-hvm-*-x86_64-gp2` owned by `amazon`

### User-Data Script Approach
- **Decision**: Use docker-compose instead of npx npm docker:up
- **Rationale**: The repository uses docker-compose.yml, which is the standard approach. Changed to `docker-compose up -d` for detached mode execution.

### Tag Compliance
- **Decision**: Apply all four required tags (Environment, Owner, CostCenter, Application) to all resources
- **Rationale**: Compliance with infrastructure standards documented in tonys-chips/INFRA.md

## Issues Encountered

### Issue 1: Security Group Array Attribute Path Syntax
- **Problem**: Initial attempts to set security group failed with errors about `SecurityGroupIdsItem` and `GroupSetItem` not being valid children
- **Resolution**: Discovered that array elements in SI don't require the item suffix. Changed from `/domain/NetworkInterfaces/0/GroupSet/0/GroupSetItem` to `/domain/NetworkInterfaces/0/GroupSet/0`

### Issue 2: Invalid Security Group Description
- **Problem**: Security group creation failed with error: "Invalid security group description. Valid descriptions are strings less than 256 characters from the following set: a-zA-Z0-9. _-:/()#,@[]+=&;{}!$*"
- **Resolution**: Removed apostrophe from "Tony's Chips" → "Tonys Chips" as apostrophes are not in AWS's allowed character set

### Issue 3: Security Group Description is Read-Only
- **Problem**: Attempted to update security group description after resource was created, received error: "cannot update create-only property at path '/domain/GroupDescription' when component has a resource attached"
- **Resolution**: Accepted that GroupDescription cannot be changed after creation for existing resources

### Issue 4: Wrong Port in Security Group
- **Problem**: Initially configured security group for port 80, but docker-compose.yml shows web app runs on port 8080 (mapped from container port 3001)
- **Resolution**: Updated security group ingress rule to allow port 8080 instead of port 80

### Issue 5: Cloud-Init Not Executing User-Data
- **Problem**: Server logs showed cloud-init warning: "Unhandled non-multipart (text/x-not-multipart) userdata". The user-data script wasn't executed.
- **Root Cause**: Initial user-data script was malformed and cloud-init didn't recognize it as executable
- **Resolution**: Completely rewrote user-data script with:
  - Proper `#!/bin/bash` shebang
  - Execution logging to `/var/log/user-data.log` for debugging
  - Use `systemctl` instead of `service` for Amazon Linux 2023
  - Run git and docker-compose as `ec2-user` using `sudo -u ec2-user`
  - Use `docker-compose up -d` for detached mode
  - Enable Docker to start on boot with `systemctl enable docker`

### Issue 6: User-Data Script Typo
- **Problem**: Original base64-decoded user-data had typo: `/qsr/local/bin/docker-compose` instead of `/usr/local/bin/docker-compose`
- **Resolution**: Fixed typo in corrected version of script

## Prompts

```prompt
I want to build an AWS EC2 Instance running on t3.small with an ssh key using the AWS::EC2::AMI resource to get the latest amazon linux ami for the region. it should pass user-data to use cloud-init to git clone https://github.com/systeminit/tonys-chips, and run the npm docker:up task.
```

```prompt
fix the failed security group description on a new change set
```

```prompt
can you update the security group for the ec2 instance to allow the port for the web app from the docker container in the source code
```

```prompt
here is the journalctl from the server, which is not running correctly: [provided server logs showing cloud-init failure]
```

## Next Steps

1. **Apply Change Sets**: Apply the change sets to HEAD to create the infrastructure (note: previous change sets may have been abandoned, use `fix-user-data-script`)

2. **Verify Deployment**: After applying, SSH into the instance and verify:
   - Check `/var/log/user-data.log` for script execution logs
   - Verify Docker containers are running: `docker ps`
   - Test web app accessibility on port 8080
   - Test API accessibility on port 3000

3. **Retrieve SSH Private Key**: The private key is stored in AWS Systems Manager Parameter Store at `/ec2/keypair/{key_pair_id}` (per AWS CloudFormation documentation)

4. **Create Public IP/DNS Access**: Instance is in private subnet, may need:
   - Elastic IP for static addressing
   - Or access via AWS Session Manager/SSM

5. **Monitor Application Logs**: Check Docker container logs:
   - `docker logs tonys-chips-web`
   - `docker logs tonys-chips-api`
   - `docker logs tonys-chips-db`

6. **Security Hardening** (Future):
   - Restrict SSH access from specific IP ranges instead of 0.0.0.0/0
   - Add HTTPS support with certificate
   - Configure proper IAM role with minimal permissions (currently SSM agent shows credential errors)

7. **Cost Optimization** (Future):
   - Review if t3.small is appropriately sized after load testing
   - Consider using spot instances for dev/test environments
