# Add Valkey ElastiCache with IAM Authentication to Sandbox Environment

**Author**: adam@systeminit.com

## Summary

Implemented AWS ElastiCache Serverless (Valkey) with IAM authentication for session storage in the sandbox environment. This work included:

1. **Infrastructure**: Created ElastiCache Serverless Cache with IAM-enabled User and UserGroup, configured security groups for web-only access, and set up IAM roles/policies for ECS task authentication.

2. **Application Code**: Added IAM authentication support to the web application with:
   - AWS SDK dependencies for SigV4 signing
   - Token generation utility using AWS credentials from ECS task role
   - 10-minute token refresh mechanism (tokens expire at 15 minutes)
   - Health check endpoint for Redis connectivity monitoring
   - Graceful startup/shutdown with detailed error diagnostics

3. **Bug Fixes**: Fixed TypeScript compilation errors (removed top-level await), resolved IAM auth configuration issues, and corrected lint errors.

4. **System Initiative**: Created infrastructure in `add-valkey-elasticache-sandbox` change set, then created two fix change sets to resolve IAM configuration issues discovered during deployment testing.

The implementation follows AWS best practices for IAM authentication with ElastiCache and matches the existing pattern used for RDS IAM authentication in the API service.

## Changes Made

### Files Modified
- `packages/web/package.json` - Added AWS SDK dependencies for IAM authentication
- `packages/web/src/index.ts` - Refactored to async start() pattern with IAM auth support, token refresh, health checks, and graceful shutdown
- `packages/web/.env.example` - Documented USE_IAM_AUTH, AWS_REGION, and REDIS_URL environment variables

### Files Created
- `packages/web/src/utils/elasticache-iam-auth.ts` - IAM token generation using AWS SigV4 signing

### Files Deleted
- None

### Infrastructure Created (System Initiative)

**Change Set: add-valkey-elasticache-sandbox (01K84FMP9QMS42JS9TRP9N30Y9)**
- `sandbox-tonys-chips-valkey-user` (AWS::ElastiCache::User) - IAM-enabled user
- `sandbox-tonys-chips-valkey-user-group` (AWS::ElastiCache::UserGroup) - User group for cache
- `sandbox-tonys-chips-valkey-sg` (AWS::EC2::SecurityGroup) - Security group for ElastiCache
- `valkey-sg-ingress-from-web` (AWS::EC2::SecurityGroupIngress) - Allow TCP 6379 from web SG only
- `sandbox-tonys-chips-valkey-cache` (AWS::ElastiCache::ServerlessCache) - Valkey Serverless Cache
- `sandbox-tonys-chips-web-task-role` (AWS::IAM::Role) - ECS task role for web service
- `sandbox-tonys-chips-elasticache-iam-policy` (AWS::IAM::ManagedPolicy) - Policy with elasticache:Connect
- `attach-elasticache-policy-to-web-task-role` (AWS::IAM::RolePolicy) - Policy attachment
- `sandbox-valkey-cache-arn` (String Template) - ARN builder for policy
- `sandbox-valkey-user-arn` (String Template) - User ARN builder for policy
- `sandbox-elasticache-iam-policy-document` (String Template) - IAM policy document
- `sandbox-valkey-redis-url` (String Template) - Redis URL from cache endpoint

**Change Set: fix-valkey-user-iam-auth (01K84SB1GGC5367XY6C0PH4T52)**
- Modified `sandbox-tonys-chips-valkey-user` - Changed UserId from "tonys-chips-valkey-user" to "tonys-chips-web" to match UserName (AWS IAM requirement)

**Change Set: fix-valkey-sg-ingress-groupid (01K84SPD79WCMVBFNZ055Q3JR2)**
- Modified `valkey-sg-ingress-from-web` - Changed from GroupName subscription to GroupId subscription to avoid AWS Cloud Control resolution issues

### Infrastructure Modified (System Initiative)
- `sandbox-tonys-chips-web-task` (AWS::ECS::TaskDefinition) - Added environment variables:
  - `USE_IAM_AUTH=true`
  - `AWS_REGION` (subscribed to Region component)
  - `REDIS_URL` (subscribed to valkey-redis-url template)
- `sandbox-tonys-chips-web-task` - Added TaskRoleArn subscription to web task role
- `tonys-chips-infraflags` (SI::CD::InfraFlags) - Removed redis, poop, canoe flags; added valkey flag for sandbox

### Infrastructure Deleted
- None

## Technical Decisions

### 1. IAM Authentication Over Password-Based Auth
**Decision**: Use IAM authentication for ElastiCache instead of traditional password-based authentication.

**Rationale**:
- Eliminates need to manage Redis passwords in Secrets Manager
- Leverages existing ECS task IAM roles
- Provides short-lived credentials (15-minute tokens)
- Follows AWS security best practices and matches the RDS IAM auth pattern already used in the API

### 2. 10-Minute Token Refresh Interval
**Decision**: Refresh IAM tokens every 10 minutes (tokens valid for 15 minutes).

**Rationale**:
- Provides 5-minute safety margin before token expiration
- More conservative than the 14-minute interval used for database connections
- Balances security (short refresh cycle) with operational overhead

### 3. Async start() Function Pattern
**Decision**: Refactor from top-level await to async `start()` function wrapper.

**Rationale**:
- Top-level await not supported with TypeScript's commonjs module configuration
- Matches existing pattern in packages/api/src/index.ts
- Provides better error handling and graceful shutdown capabilities
- Avoids need to change tsconfig.json module settings

### 4. Environment-Based IAM Auth Flag
**Decision**: Use explicit `USE_IAM_AUTH=true` environment variable instead of auto-enabling based on NODE_ENV.

**Rationale**:
- Initial implementation auto-enabled IAM when NODE_ENV=production
- docker-compose uses NODE_ENV=production locally without AWS credentials
- Explicit flag provides clearer control and avoids confusion
- Prevents credential errors in local development with docker-compose

### 5. Only Web Service Accesses ElastiCache
**Decision**: Security group allows ingress only from web-sg, not api-sg.

**Rationale**:
- API service is stateless and doesn't use sessions
- Only web service needs session storage
- Reduces attack surface
- Follows principle of least privilege

## Issues Encountered

### Issue 1: TypeScript Compilation Errors
**Problem**:
- Error: "Top-level 'await' expressions are only allowed when module option is set to es2022..."
- Error: "Variable 'redisClient' is used before being assigned"

**Root Cause**: Used top-level await with commonjs module system; redisClient variable used before async initialization completed.

**Resolution**: Refactored to async `start()` function pattern, matching the API's database connection initialization.

### Issue 2: Wrong AWS SDK Package Versions
**Problem**: Initially added @smithy/protocol-http ^4.3.0 and @smithy/signature-v4 ^4.3.0, but user reported "the latest is 5.3.3".

**Resolution**: Updated to @smithy/protocol-http ^5.3.3 and @smithy/signature-v4 ^5.3.0.

### Issue 3: Unused Variable Lint Error
**Problem**: eslint error: "'url' is assigned a value but never used" in elasticache-iam-auth.ts:33.

**Root Cause**: Had leftover `const url = ...` variable that was never used in the signing process.

**Resolution**: Removed the unused variable. The signing uses the HttpRequest object directly, not a pre-constructed URL string.

### Issue 4: IAM Auth Enabled in Local Docker
**Problem**: Web container failed to start with "CredentialsProviderError: Could not load credentials from any providers" when running docker-compose locally.

**Root Cause**: Code auto-enabled IAM auth when NODE_ENV=production, but docker-compose sets NODE_ENV=production without AWS credentials available.

**Resolution**: Changed `useIAMAuth = process.env.USE_IAM_AUTH === 'true' || process.env.NODE_ENV === 'production'` to `useIAMAuth = process.env.USE_IAM_AUTH === 'true'` (explicit opt-in only).

### Issue 5: ElastiCache User Creation Failed
**Problem**: AWS API error: "User Id and User name must be same for authentication type: iam"

**Root Cause**:
- UserId: `tonys-chips-valkey-user`
- UserName: `tonys-chips-web`
- AWS requires these to be identical for IAM authentication

**Resolution**: Created fix-valkey-user-iam-auth change set to set UserId to "tonys-chips-web" matching UserName.

### Issue 6: Security Group Ingress Failed
**Problem**: AWS Cloud Control API error: "Resource Handler Internal Failure" when creating SecurityGroupIngress.

**Root Cause**: Used GroupName subscription when the security group was being created in the same change set. AWS Cloud Control couldn't resolve the GroupName before the resource existed.

**Resolution**: Created fix-valkey-sg-ingress-groupid change set to use GroupId subscription instead of GroupName subscription, allowing AWS to properly resolve the resource reference.

## Prompts

```prompt
add the health check to the web app. look at the api implementation and the docs for using elasticache with iam auth and see if the api example has any useful patterns

[Build errors after adding health check]

can you make sure the add-valkey-elasticache-sandbox is correctly configured to auth - in particular make sure the task has the right environment variables set for web

make sure the region environment variable comes from a subscription to the region component

look at the failed create elasticache user action and fix whats wrong in a new change set

check the failed valkey-sg-ingress-from-web action and fix it in a new change set

@../tonys-chips/build-log/prompt.md
```

## Next Steps

1. **Apply Change Sets**: Apply the three change sets in order:
   - `add-valkey-elasticache-sandbox` - Creates core infrastructure
   - `fix-valkey-user-iam-auth` - Corrects UserId to match UserName
   - `fix-valkey-sg-ingress-groupid` - Fixes security group ingress reference

2. **Test Deployment**: Deploy updated web application Docker image with IAM auth code to sandbox environment.

3. **Monitor Startup**: Verify web service starts successfully and check logs for:
   - "Initializing Valkey client with IAM authentication..."
   - "Redis connection verified - PING response: PONG"
   - "Redis authentication method: IAM"

4. **Test Health Endpoints**:
   - `/health` - Basic app health
   - `/health/redis` - Redis connectivity with auth method

5. **Test Session Storage**: Verify sessions persist correctly across requests using ElastiCache.

6. **Monitor Token Refresh**: Watch logs for token refresh messages every 10 minutes to confirm refresh mechanism works.

7. **Note 12-Hour Reconnection**: Be aware that AWS auto-disconnects IAM authenticated connections after 12 hours. May need to add reconnection logic if long-running connections are needed.
