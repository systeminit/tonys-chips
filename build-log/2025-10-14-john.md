# System Initiative Infrastructure Compliance Update

**Author**: john@familywatson.co.uk

## Summary

Updated the System Initiative change set "GitHub OIDC Setup for tonys-chips" (01K7J3NE1DJ7AJMHKP050CSN3N) to comply with the infrastructure management guidelines defined in INFRA.md. The change set was missing required AWS resource tags on IAM components, which are mandatory for cost allocation, ownership tracking, and compliance enforcement.

Applied the required tagging policy to both the IAM role and managed policy components, ensuring they meet organizational standards for Environment, Owner, CostCenter, Application, and Name tags. All naming conventions were verified to follow kebab-case standards as specified in the guidelines.

## Changes Made

- **Files Modified**: 
  - `.github/workflows/pr-ci.yml` - Uncommented AWS credentials and Docker push steps
- **Files Created**: `build-log/2025-10-14-john.md`
- **Files Deleted**: None
- **Infrastructure Modified**: 
  - `tonys-chips-github-oidc-role` (IAM Role) - Added required tags, updated Owner email
  - `tonys-chips-github-actions-policy` (IAM Managed Policy) - Added required tags
  - `tonys-chips-web-ecr` (ECR Repository) - Updated to use shared-prod credentials, removed lifecycle policy
  - `tonys-chips-api-ecr` (ECR Repository) - Updated to use shared-prod credentials, removed lifecycle policy
- **Infrastructure Created**: 
  - `tonys-chips-web-ecr` (ECR Repository) - Container registry for web application
  - `tonys-chips-api-ecr` (ECR Repository) - Container registry for API application
  - `tonys-chips-shared-prod-ecr-policy` (IAM Managed Policy) - ECR access policy for shared-prod
  - `tonys-chips-shared-prod-github-oidc-role` (IAM Role) - GitHub OIDC role in shared-prod account
  - `tonys-chips-sandbox-ec2-policy` (IAM Managed Policy) - EC2 access policy for sandbox
  - `shared-prod-aws-account` (AWS Account) - Account component for shared-prod
  - `shared-prod-github-oidc-provider-arn` (String Template) - OIDC provider ARN for shared-prod
  - `shared-prod-github-trust-policy` (String Template) - Trust policy for shared-prod
  - Policy attachments linking roles to appropriate policies
- **Infrastructure Deleted**: 
  - `attach-policy-to-github-role` - Removed old ECR policy from sandbox role

## Technical Decisions

- **Multi-Account Strategy**: Created separate GitHub OIDC roles for sandbox (EC2 access) and shared-prod (ECR access) to isolate permissions appropriately
- **ECR Repository Structure**: Used `tonys-chips/web` and `tonys-chips/api` naming to organize containers by application component
- **Policy Segregation**: Sandbox role gets EC2 permissions for infrastructure testing, shared-prod role gets ECR permissions for container deployment
- **Environment Tags**: "Sandbox" for development resources, "Prod" for shared-prod resources
- **Owner Tag**: Updated all resources to use "platform-engineering@tonys-chips.com" for proper organizational alignment
- **CostCenter Tag**: Used "DevelopmentSandbox" as the default for unallocated development resources
- **Application Tag**: Used descriptive values like "tonys-chips-deployment", "tonys-chips-web", "tonys-chips-api"
- **Name Tag**: Ensured it matches the si/name value exactly for all resources as required by policy
- **Trust Policy**: Restricted GitHub OIDC access to specific repository (`systeminit/tonys-chips`) and branches (main, pull requests)

## Issues Encountered

- **Change Set Abandonment**: Initial ECR repository change set was abandoned, required creating new change set for OIDC updates
- **Account Credential Mismatch**: Initially created ECR repositories with wrong AWS credentials (sandbox instead of shared-prod), required correction
- **Policy Cleanup**: Had to remove and recreate policy attachments as we refined the multi-account strategy

## Prompts

```prompt
Look at the change set 01K7J3NE1DJ7AJMHKP050CSN3N and understand the changes proposed

read ./tonys-chips/INFRA.md and apply the changes needed to meet the criteria

Ok - what do I need to my github environment for sandbox based on the content in ./tonys-chips/.github/ for assuming the right role?

ok - uncomment the docker push task

Ok - create a new change set to add a new ECR Repository to the shared-prod account. I want two of them. One for tonys-chips-web and one for tonys-chips-api

I want it in shared-prod, not sandbox. you've attached the wrong credential

Remove the lifecycle rules for now

Update the Owner tags universally to platform-engineering@tonys-chips.com (only update, don't add it if the tag doesn't exist)

Add a new OIDC policy for the shared-prod account that also allows github to read write into ECR in there. Remove the original one we created

the actual role is in the wrong account though, right?

Create a new one in shared-prod, leave the one in sandbox with no policies attached, we might need it later

For the policy in sandbox for OIDC, can we change that to be all EC2 actions instead of ECR?

Remove the other policies attached for sandbox, I restored them but remove them again if appropriate

Make sure the policy in INFRA.md is adhered to

@tonys-chips/build-log/prompt.md
```

## Final Resolution - OIDC Authentication Issue

After deploying all infrastructure, GitHub Actions was failing with "Not authorized to perform sts:AssumeRoleWithWebIdentity" error. 

**Root Cause**: Trust policy mismatch between expected and actual OIDC token claims:
- **Expected**: `repo:systeminit/tonys-chips:ref:refs/heads/main` or `repo:systeminit/tonys-chips:pull_request`
- **Actual**: `repo:systeminit/tonys-chips:environment:shared` (due to using `environment: shared` in workflow)

**Solution**: Updated trust policy in change set `01K7JBJDF8S3W8SGP18V9MFMWX` to include:
```json
"repo:systeminit/tonys-chips:environment:shared"
```

**GitHub Environment Setup Required**:
- Environment name: `shared`
- Variables needed:
  - `AWS_ROLE_ARN`: `arn:aws:iam::839690184014:role/tonys-chips-github-actions-shared-prod`
  - `AWS_REGION`: `us-east-1`
  - `AWS_ACCOUNT_ID`: `839690184014`
  - `ECR_API_REPO`: `tonys-chips/api`
  - `ECR_WEB_REPO`: `tonys-chips/web`
  - `VITE_API_URL`: (sandbox API URL)

## Next Steps

- Apply the change set `01K7JBJDF8S3W8SGP18V9MFMWX` ("Fix GitHub Actions OIDC Trust Policy for Shared Environment") to HEAD
- Test GitHub Actions workflow - authentication should now work
- Monitor ECR push operations for any additional issues
- Consider creating reusable templates for multi-account OIDC setups