# Added ECR Lifecycle Policies to Container Repositories

**Author**: public@paulstack.co.uk

## Summary

Added best practice lifecycle policies to both ECR repositories (tonys-chips-web-ecr and tonys-chips-api-ecr) to automatically manage image retention and reduce storage costs. The policies implement a three-tier retention strategy: keeping the last 10 production images, last 5 staging images, and expiring untagged images after 14 days.

## Changes Made

- **Files Modified**: None
- **Files Created**: None
- **Files Deleted**: None

### Infrastructure Modified in System Initiative

**Change Set: add-ecr-lifecycle-policies**

- **tonys-chips-web-ecr** (AWS::ECR::Repository) - Added LifecyclePolicy with 3 rules
- **tonys-chips-api-ecr** (AWS::ECR::Repository) - Added LifecyclePolicy with 3 rules

## Technical Decisions

### Lifecycle Policy Design

- **Decision**: Implement three-tier retention strategy with different rules for production, staging, and untagged images
- **Rationale**: Balances cost optimization with operational requirements
  - Production images need longer retention for rollback capability
  - Staging images need shorter retention as they're less critical
  - Untagged images accumulate from CI/CD and should be cleaned up automatically

### Production Image Retention (Rule 1)

- **Decision**: Keep last 10 images tagged with `prod-` or `v` prefixes
- **Rationale**:
  - Provides adequate rollback history (10 versions)
  - Supports semantic versioning convention (`v` prefix)
  - Covers typical production deployment cadence

### Staging Image Retention (Rule 2)

- **Decision**: Keep last 5 images tagged with `staging-` or `dev-` prefixes
- **Rationale**:
  - Lower retention for non-production environments
  - Still maintains recent history for debugging
  - Reduces storage costs for frequently updated environments

### Untagged Image Cleanup (Rule 3)

- **Decision**: Expire untagged images after 14 days
- **Rationale**:
  - Untagged images are typically build artifacts or failed pushes
  - 14-day window provides safety buffer for investigation
  - Prevents repository bloat from CI/CD pipelines

### Policy Structure

- **Decision**: Use JSON string format for LifecyclePolicyText attribute
- **Rationale**: AWS ECR requires lifecycle policies as JSON documents per CloudFormation specification

## Issues Encountered

None - both repositories successfully updated with lifecycle policies and passed all qualification checks.

## Prompts

```prompt
I want you to open a change set and add the best practice ECR Lifecycle rules for our AWS::ECR::Repositiory components
```

## Next Steps

1. **Apply the change set**: Run the apply operation on `add-ecr-lifecycle-policies` change set to implement the lifecycle policies in AWS ECR

2. **Monitor initial cleanup**: After applying, check CloudWatch metrics to see how many images are initially cleaned up by the new policies

3. **Verify policy effectiveness**:
   - Review ECR repository size reduction over the next few days
   - Confirm that production images are being retained as expected
   - Check that untagged images are being properly cleaned up

4. **Cost analysis**: Compare ECR storage costs before and after policy implementation to quantify savings

5. **Consider adjustments**: Based on operational needs, may want to adjust:
   - Number of production images retained (currently 10)
   - Number of staging images retained (currently 5)
   - Untagged image expiration period (currently 14 days)

6. **Document tagging conventions**: Ensure CI/CD pipelines are following the expected tagging patterns (`prod-`, `v`, `staging-`, `dev-`) for the lifecycle policies to work correctly
