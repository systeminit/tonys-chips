# Database Migrations Guide

## Overview

This document explains how Prisma migrations are handled in the Tony's Chips API, both for local development and production deployments to ECS.

---

## Migration Strategy

### Production (ECS)
- **Method:** Migrations run automatically via Docker entrypoint script
- **Timing:** Before application starts
- **Command:** `npx prisma migrate deploy`
- **Safety:** Built-in database connectivity check before migrations

### Local Development
- **Method:** Manual migrations via npm scripts
- **Command:** `npm run migrate:dev`

---

## How It Works in ECS

### Deployment Flow

1. **Container Starts**
   ```
   docker-entrypoint.sh executes
   ```

2. **Database Connectivity Check**
   ```bash
   Checks database is reachable
   Retries every 2 seconds until connection succeeds
   Times out if database unavailable
   ```

3. **Run Migrations**
   ```bash
   npx prisma migrate deploy
   Applies all pending migrations from prisma/migrations/
   Idempotent - safe to run multiple times
   ```

4. **Generate Prisma Client**
   ```bash
   npx prisma generate
   Ensures Prisma Client matches schema
   ```

5. **Start Application**
   ```bash
   node dist/index.js
   Application starts only if migrations succeed
   ```

### Race Condition Handling

**Problem:** Multiple ECS tasks starting simultaneously could try to run migrations concurrently.

**Solution:** Prisma's `migrate deploy` is designed to handle this:
- Uses database-level locking via `_prisma_migrations` table
- First task acquires lock and runs migrations
- Other tasks wait for lock, then see migrations already applied
- All tasks proceed safely

### Failure Handling

**If migrations fail:**
- Container exits with error code
- ECS task marked as failed
- No application containers start
- Deployment rolls back (if using CodeDeploy/Blue-Green)

**Health Check Impact:**
- Application won't respond to health checks if migrations fail
- ALB/ECS health checks will fail
- Failed tasks automatically restarted by ECS
- Manual intervention needed if migrations consistently fail

---

## NPM Scripts

### Production Scripts

```bash
# Apply pending migrations (used in Docker entrypoint)
# Note: Initial product data is automatically seeded via migration
npm run migrate
```

### Development Scripts

```bash
# Create and apply a new migration
npm run migrate:dev

# Create a migration without applying it
npm run migrate:create

# Push schema changes directly to database (no migration files)
npm run db:push

# Note: Initial product data is included in migrations
# Run migrations to seed the database
npm run migrate:dev
```

---

## Creating New Migrations

### Step 1: Update Prisma Schema

Edit `prisma/schema.prisma`:
```prisma
model Product {
  id          String   @id @default(cuid())
  name        String
  price       Float
  description String?  // New field added
  createdAt   DateTime @default(now())
}
```

### Step 2: Create Migration

```bash
npm run migrate:dev
# Or specify a name:
npx prisma migrate dev --name add_product_description
```

This will:
1. Generate SQL migration files in `prisma/migrations/`
2. Apply migration to local database
3. Regenerate Prisma Client

### Step 3: Commit Migration Files

```bash
git add prisma/migrations/
git commit -m "Add product description field"
git push
```

### Step 4: Deploy

When deployed to ECS:
- Docker image includes new migration files
- Entrypoint script runs `prisma migrate deploy`
- New migration automatically applied to production database

---

## Migration Files Structure

```
prisma/
├── migrations/
│   ├── 20241001120000_init/
│   │   └── migration.sql
│   ├── 20241015093000_add_products/
│   │   └── migration.sql
│   ├── 20241020140000_add_product_description/
│   │   └── migration.sql
│   ├── 20251021000000_seed_products/
│   │   └── migration.sql
│   └── migration_lock.toml
└── schema.prisma
```

**migration_lock.toml:**
- Locks migrations to specific database provider (PostgreSQL)
- Prevents applying PostgreSQL migrations to MySQL, etc.

---

## IAM Authentication Considerations

### Challenge
Prisma migrations need database access, but IAM tokens expire every 15 minutes.

### Solution in Entrypoint Script
The `docker-entrypoint.sh` script:
1. Waits for database connectivity (handles IAM token generation)
2. Runs migrations immediately while token is fresh
3. Token generated by `buildDatabaseUrl()` in `secrets.ts`
4. Migration typically completes in seconds, well within 15-minute window

### Environment Variables Required
```bash
DB_HOST=<rds-proxy-endpoint>
DB_PORT=5432
DB_NAME=tonyschips
DB_USER=postgres
DB_USE_IAM_AUTH=true
AWS_REGION=us-east-1
```

---

## Rollback Procedures

### Scenario 1: Bad Migration Applied

**Option A: Create a Revert Migration**
```bash
# Locally, create migration that undoes changes
npm run migrate:create

# Edit the generated migration.sql to undo changes
# Example: DROP COLUMN instead of ADD COLUMN

# Test locally
npm run migrate:dev

# Commit and deploy
git add prisma/migrations/
git commit -m "Revert: add product description"
git push
```

**Option B: Restore from RDS Snapshot**
1. Stop all ECS tasks
2. Restore RDS from backup (Aurora automatic backups)
3. Update migrations table to match restored state
4. Redeploy previous working version

### Scenario 2: Migration Fails on Deploy

**Automatic Recovery:**
- ECS task fails health checks
- Task automatically restarts
- If persistent failure, deployment rolls back (with CodeDeploy)

**Manual Recovery:**
1. Check CloudWatch logs for migration error
2. Fix migration SQL or schema
3. Create corrective migration
4. Redeploy

### Scenario 3: Data Loss Risk

**Prevention:**
- Test migrations on development/staging first
- Review generated SQL before committing
- Use transactions (Prisma migrations are transactional by default)
- Maintain regular Aurora backups (7-day retention configured)

---

## Best Practices

### Development

1. **Always create descriptive migration names:**
   ```bash
   npx prisma migrate dev --name add_user_email_verification
   ```

2. **Review generated SQL:**
   ```bash
   cat prisma/migrations/*/migration.sql
   ```

3. **Test migrations locally first:**
   ```bash
   # Reset database
   npx prisma migrate reset

   # Reapply all migrations
   npm run migrate:dev
   ```

4. **Never edit applied migrations:**
   - Once committed and deployed, migrations are immutable
   - Create new migrations to fix issues

### Production

1. **Test in staging environment:**
   - Apply migrations to staging database first
   - Verify application functionality
   - Check performance impact

2. **Monitor deployment:**
   ```bash
   # Watch ECS task logs
   aws logs tail /ecs/sandbox-tonys-chips-api --follow
   ```

3. **Backup before major migrations:**
   ```bash
   # Create manual snapshot
   aws rds create-db-cluster-snapshot \
     --db-cluster-identifier tonys-chips-sandbox-aurora \
     --db-cluster-snapshot-identifier pre-migration-$(date +%Y%m%d-%H%M%S)
   ```

4. **Consider maintenance windows:**
   - For destructive changes (DROP COLUMN)
   - For large data migrations
   - Schedule during low-traffic periods

---

## Troubleshooting

### Migration Fails: "Connection Timeout"

**Cause:** Database not accessible or IAM token generation failed

**Solution:**
1. Check security group allows ECS task access
2. Verify RDS Proxy is healthy
3. Check IAM task role has `rds-db:connect` permission
4. Review CloudWatch logs for IAM token errors

### Migration Fails: "Syntax Error"

**Cause:** Invalid SQL in migration file

**Solution:**
1. Review migration SQL:
   ```bash
   cat prisma/migrations/[timestamp]_[name]/migration.sql
   ```
2. Fix in a new migration or rollback
3. Test locally before redeploying

### Migration Hangs

**Cause:** Database lock or long-running operation

**Solution:**
1. Check for active queries blocking migration:
   ```sql
   SELECT * FROM pg_stat_activity WHERE state = 'active';
   ```
2. Increase ECS task timeout if needed
3. Consider running large migrations separately

### "Migration Already Applied"

**Cause:** Normal - Prisma detects migration already ran

**Solution:**
- No action needed
- This is expected behavior
- Migrations are idempotent

### Multiple Tasks Racing

**Cause:** Multiple ECS tasks starting simultaneously

**Solution:**
- No action needed
- Prisma handles this with database locks
- Second task waits for first to complete
- Both tasks start successfully

---

## Monitoring

### Key Metrics to Watch

1. **ECS Task Startup Time:**
   - Normal: 10-30 seconds
   - With migrations: 15-60 seconds
   - Alert if > 2 minutes

2. **Migration Duration:**
   - Log shows: "Migrations completed successfully"
   - Check CloudWatch logs for timing
   - Alert if consistently slow

3. **Task Failure Rate:**
   - Should be near 0%
   - Alert on repeated failures
   - Indicates migration problems

### CloudWatch Logs

**Search for migration logs:**
```
/ecs/sandbox-tonys-chips-api
Filter: "Running database migrations"
```

**Successful migration:**
```
Starting Tony's Chips API...
Checking database connectivity...
Database is ready
Running database migrations...
Migrations completed successfully
Ensuring Prisma Client is up to date...
Starting application...
Server listening on port 3000
```

**Failed migration:**
```
Starting Tony's Chips API...
Checking database connectivity...
Database is ready
Running database migrations...
ERROR: Migrations failed
```

---

## Alternative Approaches (Future Improvements)

### Option 1: ECS Init Containers (Recommended Upgrade)

**When ECS supports init containers:**

```json
{
  "containerDefinitions": [
    {
      "name": "migration",
      "image": "tonys-chips-api:latest",
      "essential": false,
      "command": ["npx", "prisma", "migrate", "deploy"],
      "dependsOn": []
    },
    {
      "name": "api",
      "image": "tonys-chips-api:latest",
      "essential": true,
      "dependsOn": [
        {
          "containerName": "migration",
          "condition": "SUCCESS"
        }
      ]
    }
  ]
}
```

**Benefits:**
- Cleaner separation
- Application container only starts if migration succeeds
- No entrypoint script needed

### Option 2: CodePipeline Pre-Deployment Hook

**Add to CodePipeline:**

```yaml
- Name: RunMigrations
  ActionTypeId:
    Category: Invoke
    Owner: AWS
    Provider: Lambda
  Configuration:
    FunctionName: RunPrismaMigrations
  RunOrder: 1

- Name: DeployToECS
  RunOrder: 2
```

**Benefits:**
- Migrations run once per deployment
- No race conditions
- Clear audit trail

**Drawbacks:**
- Requires Lambda in VPC
- Additional infrastructure
- More complex setup

### Option 3: AWS Systems Manager Run Command

**Use SSM to run migration task:**

```bash
aws ecs run-task \
  --cluster tonys-chips-sandbox \
  --task-definition tonys-chips-api-migration \
  --launch-type FARGATE \
  --count 1
```

**Benefits:**
- One-off migration task
- Controlled execution
- No race conditions

**Drawbacks:**
- Requires separate task definition
- Manual step in deployment
- CI/CD integration needed

---

## Security Considerations

### Secrets in Migrations

**Don't:**
- Hardcode sensitive data in migration files
- Commit API keys or passwords

**Do:**
- Use environment variables for sensitive data
- Reference Secrets Manager in application code
- Use data migrations for sensitive defaults (e.g., SQL INSERT statements in migration files)

### Database User Permissions

**Migration user needs:**
- CREATE, ALTER, DROP permissions on tables
- SELECT, INSERT, UPDATE, DELETE on `_prisma_migrations` table
- Schema modification permissions

**Production setup:**
- Using IAM auth: User has full permissions via IAM policy
- Database user: `postgres` (master user)
- Consider creating dedicated migration user with limited permissions

---

## Resources

### Prisma Documentation
- [Prisma Migrate](https://www.prisma.io/docs/concepts/components/prisma-migrate)
- [Deploy Migrations](https://www.prisma.io/docs/guides/deployment/deploy-database-changes-with-prisma-migrate)
- [Migration Troubleshooting](https://www.prisma.io/docs/guides/database/troubleshooting-orm)

### AWS Documentation
- [ECS Task Definition Parameters](https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_definition_parameters.html)
- [RDS IAM Authentication](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/UsingWithRDS.IAMDBAuth.html)

### Internal Documentation
- Build Log: `/build-log/20251020-paul.md`
- Application Code: `/packages/api/src/`
- Prisma Schema: `/packages/api/prisma/schema.prisma`

---

## Support

**Issues with migrations?**
1. Check CloudWatch logs: `/ecs/sandbox-tonys-chips-api`
2. Review this guide's troubleshooting section
3. Test migration locally first
4. Contact DevOps team if persistent issues

**Creating new migrations?**
1. Follow "Creating New Migrations" section
2. Test thoroughly in development
3. Review generated SQL
4. Deploy to staging first
5. Monitor production deployment

---

**Last Updated:** October 20, 2025
**Author:** Claude Code
**Status:** Production Ready
